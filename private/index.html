<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Notes - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="login-container">
        <h1>üîí Private Notes</h1>
        <p>Enter your password</p>

        <form id="loginForm">
            <input
                type="password"
                id="password"
                placeholder="Password"
                autocomplete="new-password"
                required
            >
            <button type="submit">Enter</button>
        </form>

        <div id="error" class="error"></div>
    </div>

    <script>
        const form = document.getElementById('loginForm');
        const passwordInput = document.getElementById('password');
        const errorDiv = document.getElementById('error');

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú password ÌïÑÎìú Í∞ïÏ†ú ÌÅ¥Î¶¨Ïñ¥
        passwordInput.value = '';

        // localStorageÎèÑ ÌôïÏù∏
        console.log('Current localStorage contents:');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            console.log(`  ${key}:`, localStorage.getItem(key));
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorDiv.textContent = '';

            const password = passwordInput.value;

            console.log('Password field value:', password);
            console.log('Password length:', password.length);
            console.log('Password starts with:', password.substring(0, 10));

            // JWT ÌÜ†ÌÅ∞ÏùÄ Î≥¥ÌÜµ "eyJ"Î°ú ÏãúÏûëÌï©ÎãàÎã§
            if (password.startsWith('eyJ')) {
                alert('WARNING: Password field contains a JWT token, not a password!\nClearing...');
                passwordInput.value = '';
                return;
            }

            try {
                const requestBody = { password };
                console.log('Sending request body:', requestBody);
                console.log('Request body JSON:', JSON.stringify(requestBody));

                // Î®ºÏ†Ä ÎîîÎ≤ÑÍ∑∏ API Ìò∏Ï∂ú
                const debugResponse = await fetch('https://notes-4rdgtdjdt-ysw421s-projects.vercel.app/api/debug', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const debugData = await debugResponse.json();
                console.log('DEBUG API Response:', debugData);
                alert('DEBUG: ' + JSON.stringify(debugData, null, 2));

                const response = await fetch('https://notes-4rdgtdjdt-ysw421s-projects.vercel.app/api/github-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login response:', data);
                    console.log('Token:', data.token);

                    if (!data.token) {
                        alert('ERROR: API returned no token! Response: ' + JSON.stringify(data));
                        errorDiv.textContent = '‚ùå Server error: No token received';
                        return;
                    }

                    localStorage.setItem('auth_token', data.token);
                    const stored = localStorage.getItem('auth_token');
                    console.log('Stored token:', stored);

                    if (!stored) {
                        alert('ERROR: Token not stored in localStorage!');
                        errorDiv.textContent = '‚ùå Failed to save login session';
                        return;
                    }

                    alert('Success! Token stored: ' + stored.substring(0, 20) + '...');
                    window.location.href = 'viewer.html';
                } else {
                    errorDiv.textContent = '‚ùå Incorrect password';
                    passwordInput.value = '';
                }
            } catch (error) {
                errorDiv.textContent = '‚ùå Connection error: ' + error.message;
            }
        });
    </script>
</body>
</html>
