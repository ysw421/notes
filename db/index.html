<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Notes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css" id="loginStyle">
    <link rel="stylesheet" href="viewer.css" id="viewerStyle" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8%2F9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAjFJREFUeNqsU8uOElEQPffR3XQ3ONASdBJCSBxHos5%2B3Bg3rvkCv8PElS78gPkO%2FATjQoUdO2ftrJiRh6aneTb9sOpC4weMN6lcuFV16pxDIfI8x12OYIDhcPiu2Wx%2B%2FHF5CW1Z6Jyegt%2FTNEWSJIjjGFEUIQxDrFYrWFSzXC4%2FdLvd95pRKpXKy%2BpRFZ7nwaWo1%2BsGnQG2240BKJfLKJVKGI1GEEJw7eteryd0v993W63WEwjgxfn5obGYzgCbzcaEbdsIggDj8Riu6z6iUk9SYZMSx8W0LMsM%2FSKK75xnJlIq80anQXdbEp0OhcPJ0eiaJnGRMEyyPDsAKKUM9clkYoDo3SZJzzSdp0VSKYmfV1co%2Bz580kw5KDIM8RbRfEnUf1HzxtQyMAGcaGruTKczMzEIaqhKifV6jd%2BzGQQB5llunF%2FM52BizC2K5sYPYvZcu653tjOM9O93wnYc08gmkgg4VAxixfqFUJT36AYBZGd6PJkFCZnnlBxMp38gqIgLpZB0y4Nph18lyWh5FFbrOSxbl3V4G%2BVB7T4ajYYxTyuLtO%2BCvWGgJE1Mc7JNsJEhvgw%2FQV4fo%2F24nbEsX2u1d5sVyn8sJO0ZAQiIYnFh%2BxrfLz%2Fj29cBS%2FO14zg3i8XigW3ZkErDtmKoeM%2BAJGRMnXeEPGKf0nCD1ydvkDzU9Jbc6OpR7WIw6L8lQ%2B4pQ1%2FlPF0RGM9Ns91Wmptk0GfB4EJkt77vXYj%2F8m%2B8y%2FkrwABHbz2H9V68DQAAAABJRU5ErkJggg%3D%3D">
</head>
<body dir="ltr">
    <script>
        async function loadComponents() {
            const loginResponse = await fetch('../components/login.html');
            const loginHTML = await loginResponse.text();
            document.body.insertAdjacentHTML('afterbegin', loginHTML);

            const viewerResponse = await fetch('../components/viewer.html');
            const viewerHTML = await viewerResponse.text();
            document.body.insertAdjacentHTML('beforeend', viewerHTML);
        }
    </script>
    <script>
        // Check authentication and show appropriate section
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const loginSection = document.getElementById('loginSection');
            const viewerSection = document.getElementById('viewerSection');
            const loginStyle = document.getElementById('loginStyle');
            const viewerStyle = document.getElementById('viewerStyle');

            if (token) {
                loginSection.style.display = 'none';
                viewerSection.style.display = 'block';
                loginStyle.disabled = true;
                viewerStyle.disabled = false;
                initViewer();
            } else {
                loginSection.style.display = 'block';
                viewerSection.style.display = 'none';
                loginStyle.disabled = false;
                viewerStyle.disabled = true;
                initLogin();
            }
        }

        // Login functionality
        function initLogin() {
            const form = document.getElementById('loginForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const errorDiv = document.getElementById('error');

            if (!form) return;

            usernameInput.value = '';
            passwordInput.value = '';

            form.onsubmit = async (e) => {
                e.preventDefault();
                errorDiv.textContent = '';

                const username = usernameInput.value;
                const password = passwordInput.value;

                try {
                    const apiUrl = window.location.hostname === 'localhost'
                        ? 'http://localhost:3000/api/github-proxy'
                        : 'https://notes-api.ysw421.workers.dev';

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('auth_token', data.token);
                        localStorage.setItem('username', username);
                        directoryCache = {};
                        checkAuth();
                    } else {
                        errorDiv.textContent = '‚ùå Incorrect username or password';
                        passwordInput.value = '';
                    }
                } catch (error) {
                    errorDiv.textContent = '‚ùå Connection error: ' + error.message;
                }
            };
        }

        // Viewer functionality
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api/github-proxy'
            : 'https://notes-api.ysw421.workers.dev';
        let currentPath = '';
        let gRows = [];
        let gOrderBy = -1;
        let gTable;
        let gTBody;
        let directoryCache = {};
        let currentFileData = null;

        const FILE_ICONS = {
            'pdf': 'fa-file-pdf', 'doc': 'fa-file-word', 'docx': 'fa-file-word',
            'txt': 'fa-file-lines', 'md': 'fa-file-lines', 'rtf': 'fa-file-word',
            'js': 'fa-file-code', 'jsx': 'fa-file-code', 'ts': 'fa-file-code',
            'tsx': 'fa-file-code', 'py': 'fa-file-code', 'java': 'fa-file-code',
            'cpp': 'fa-file-code', 'c': 'fa-file-code', 'html': 'fa-file-code',
            'css': 'fa-file-code', 'php': 'fa-file-code', 'go': 'fa-file-code',
            'rs': 'fa-file-code', 'rb': 'fa-file-code', 'tex': 'fa-file-code',
            'png': 'fa-file-image', 'jpg': 'fa-file-image', 'jpeg': 'fa-file-image',
            'gif': 'fa-file-image', 'svg': 'fa-file-image', 'webp': 'fa-file-image',
            'bmp': 'fa-file-image', 'ico': 'fa-file-image',
            'zip': 'fa-file-zipper', 'tar': 'fa-file-zipper', 'gz': 'fa-file-zipper',
            'rar': 'fa-file-zipper', '7z': 'fa-file-zipper', 'bz2': 'fa-file-zipper',
            'json': 'fa-file-code', 'xml': 'fa-file-code', 'csv': 'fa-file-csv',
            'xlsx': 'fa-file-excel', 'xls': 'fa-file-excel',
            'mp3': 'fa-file-audio', 'wav': 'fa-file-audio', 'ogg': 'fa-file-audio',
            'flac': 'fa-file-audio', 'mp4': 'fa-file-video', 'avi': 'fa-file-video',
            'mov': 'fa-file-video', 'mkv': 'fa-file-video',
            'log': 'fa-file-lines', 'bib': 'fa-file-lines', 'aux': 'fa-file',
            'out': 'fa-file', 'toc': 'fa-file-lines', 'idx': 'fa-file',
            'ind': 'fa-file', 'fls': 'fa-file', 'fdb_latexmk': 'fa-file',
            'ilg': 'fa-file', 'synctex': 'fa-file',
        };

        const FILE_COLORS = {
            'fa-file-pdf': '#F44336', 'fa-file-word': '#2196F3',
            'fa-file-code': '#4CAF50', 'fa-file-image': '#9C27B0',
            'fa-file-zipper': '#FF9800', 'fa-file-excel': '#217346',
            'fa-file-csv': '#4CAF50', 'fa-file-audio': '#E91E63',
            'fa-file-video': '#673AB7', 'fa-file-lines': '#607D8B',
        };

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return FILE_ICONS[ext] || 'fa-file';
        }

        function getIconColor(iconClass) {
            return FILE_COLORS[iconClass] || '#757575';
        }

        function initViewer() {
            gTable = document.getElementById("dirTable");
            gTBody = document.getElementById("tbody");

            window.removeEventListener('hashchange', handleHashChange);
            window.addEventListener('hashchange', handleHashChange);
            handleHashChange();
        }

        function handleHashChange() {
            const hash = window.location.hash.slice(1);
            let path = decodeURIComponent(hash || '');

            const token = localStorage.getItem('auth_token');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const { role, permissions } = payload;

                    if (role !== 'admin' && !path) {
                        const basePath = permissions.basePath.replace(/^\//, '');
                        path = basePath;
                    }
                } catch (error) {
                    console.error('Failed to decode token:', error);
                }
            }

            loadFiles(path);
        }

        async function loadFiles(path) {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                checkAuth();
                return;
            }

            const tbody = document.getElementById('tbody');
            const title = document.getElementById('title');
            const goUp = document.getElementById('UI_goUp');
            const upLink = document.getElementById('upLink');
            const contentViewer = document.getElementById('contentViewer');

            contentViewer.style.display = 'none';
            gTable.style.display = 'table';
            currentFileData = null;

            currentPath = path;

            const payload = JSON.parse(atob(token.split('.')[1]));
            const { role, permissions } = payload;

            title.textContent = 'Index of /' + path;

            if (path) {
                const parentPath = path.split('/').slice(0, -1).join('/');
                upLink.href = '#' + encodeURIComponent(parentPath);

                if (role !== 'admin') {
                    const basePath = permissions.basePath.replace(/^\//, '');
                    if (path === basePath) {
                        goUp.style.display = 'none';
                    } else {
                        goUp.style.display = 'block';
                    }
                } else {
                    goUp.style.display = 'block';
                }
            } else {
                goUp.style.display = 'none';
            }

            const downloadAllBtn = document.querySelector('.btn-download-all');

            if (directoryCache[path]) {
                renderFiles(directoryCache[path]);
                prefetchSubfolders(directoryCache[path]);
                return;
            }

            if (downloadAllBtn) {
                downloadAllBtn.disabled = true;
                downloadAllBtn.style.display = 'inline-flex';
            }

            tbody.innerHTML = '<tr style="height:0;visibility:hidden;"><td></td><td></td><td></td></tr><tr><td colspan="3">Loading...</td></tr>';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, path })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('auth_token');
                        checkAuth();
                        return;
                    }
                    throw new Error('Request failed');
                }

                const files = await response.json();

                directoryCache[path] = files;

                renderFiles(files);

                prefetchSubfolders(files);

            } catch (error) {
                tbody.innerHTML = `<tr style="height:0;visibility:hidden;"><td></td><td></td><td></td></tr><tr><td colspan="3" style="color:red;">Error: ${error.message}</td></tr>`;
            }
        }

        async function prefetchSubfolders(files) {
            const token = localStorage.getItem('auth_token');
            const folders = files.filter(f => f.type === 'dir');

            for (const folder of folders) {
                if (!directoryCache[folder.path]) {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token, path: folder.path })
                        });

                        if (response.ok) {
                            const subFiles = await response.json();
                            directoryCache[folder.path] = subFiles;
                            await prefetchSubfolders(subFiles);
                        }
                    } catch (error) {
                    }
                }
            }

            await prefetchParentFolder();
        }

        async function prefetchParentFolder() {
            if (!currentPath) return;

            const token = localStorage.getItem('auth_token');
            const parentPath = currentPath.split('/').slice(0, -1).join('/');

            if (!directoryCache[parentPath]) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token, path: parentPath })
                    });

                    if (response.ok) {
                        const parentFiles = await response.json();
                        directoryCache[parentPath] = parentFiles;
                    }
                } catch (error) {
                }
            }
        }

        function renderFiles(files) {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';
            gRows = [];

            const downloadAllBtn = document.querySelector('.btn-download-all');
            const hasFiles = files.some(f => f.type === 'file');
            if (downloadAllBtn) {
                downloadAllBtn.style.display = hasFiles ? 'inline-flex' : 'none';
                downloadAllBtn.disabled = false;
            }

            files.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'dir' ? -1 : 1;
            });

            const token = localStorage.getItem('auth_token');
            const payload = JSON.parse(atob(token.split('.')[1]));
            const { role, permissions } = payload;

            files.forEach(file => {
                const tr = document.createElement('tr');
                const isDir = file.type === 'dir';
                const iconClass = isDir ? 'fa-folder' : getFileIcon(file.name);
                const iconColor = isDir ? '#FFA726' : getIconColor(iconClass);
                const size = file.size ? formatSize(file.size) : '';

                let hasAccess = true;
                let fileName = file.name;

                if (role !== 'admin') {
                    const filePath = '/' + file.path;

                    const isExplicitlyAllowed = permissions.allowed.some(allowedPath =>
                        filePath === allowedPath || filePath.startsWith(allowedPath + '/')
                    );

                    if (!isExplicitlyAllowed) {
                        const isDenied = permissions.denied.some(deniedPath =>
                            filePath === deniedPath || filePath.startsWith(deniedPath + '/')
                        );

                        if (isDenied) {
                            hasAccess = false;
                            fileName = 'üîí Locked';
                        }
                    }
                }

                const linkHref = hasAccess ? (isDir ? '#' + encodeURIComponent(file.path) : '#') : '#';
                const clickHandler = hasAccess ? (isDir ? '' : `onclick="openFile(this); return false;"`) : 'onclick="return false;"';
                const linkStyle = hasAccess ? '' : 'style="cursor: not-allowed; opacity: 0.5;"';

                const downloadBtn = (isDir || !hasAccess)
                    ? ''
                    : `<button class="btn-download-inline" onclick="downloadFileInline(this); event.stopPropagation();"><i class="fa-solid fa-download"></i></button>`;

                tr.innerHTML = `<td sortable-data="${isDir ? '1' : '2'}${file.name.toLowerCase()}"><table class="ellipsis"><tbody><tr><td><a class="${isDir ? 'dir' : 'file'}" href="${linkHref}" ${clickHandler} ${linkStyle}><i class="fa-solid ${iconClass}" style="color:${iconColor}"></i>${fileName}${isDir && hasAccess ? '/' : ''}</a></td></tr></tbody></table></td><td sortable-data="${file.size || 0}">${hasAccess ? size : ''}</td><td>${downloadBtn}</td>`;

                tr.fileData = file;
                gRows.push(tr);
                tbody.appendChild(tr);
            });

            if (gRows.length < 2) return;
            gTable.setAttribute("order", "");
        }

        function openFile(element) {
            const tr = element.closest('table.ellipsis').parentElement.parentElement;
            const file = tr.fileData;

            if (!file) {
                alert('File data not found');
                return;
            }

            const token = localStorage.getItem('auth_token');
            const fileUrl = `file.html?path=${encodeURIComponent(file.path)}&token=${encodeURIComponent(token)}`;
            window.open(fileUrl, '_blank');
        }

        async function downloadFileInline(element) {
            const token = localStorage.getItem('auth_token');
            const tr = element.closest('tr');
            const file = tr ? tr.fileData : null;

            if (!file) {
                alert('File data not found');
                return;
            }

            try {
                let bytes;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, path: file.path })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('auth_token');
                        checkAuth();
                        return;
                    }
                    throw new Error('Failed to load file');
                }

                const fileData = await response.json();
                file.content = fileData.content;
                file.download_url = fileData.download_url;

                if ((!file.content || file.content.length === 0) && file.download_url) {
                    const response = await fetch(file.download_url);
                    if (!response.ok) {
                        throw new Error('Failed to download file from URL');
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    bytes = new Uint8Array(arrayBuffer);
                } else if (file.content && file.content.length > 0) {
                    const binaryString = atob(file.content);
                    const len = binaryString.length;
                    bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                } else {
                    throw new Error('File content is empty and no download URL available');
                }

                const blob = new Blob([bytes], { type: 'application/octet-stream' });

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        }

        async function downloadAll() {
            const token = localStorage.getItem('auth_token');
            const downloadBtn = document.querySelector('.btn-download-all');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>Downloading...';

            try {
                const zip = new JSZip();

                async function addFilesToZip(dirPath, zipFolder) {
                    let files = directoryCache[dirPath];

                    if (!files) {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token, path: dirPath })
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                localStorage.removeItem('auth_token');
                                checkAuth();
                                throw new Error('Authentication required');
                            }
                            throw new Error(`Failed to load directory: ${dirPath}`);
                        }

                        files = await response.json();
                        directoryCache[dirPath] = files;
                    }

                    for (const item of files) {
                        if (item.type === 'file') {
                            let byteArray;

                            const response = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token, path: item.path })
                            });

                            if (!response.ok) {
                                throw new Error(`Failed to load ${item.name}`);
                            }

                            const fileData = await response.json();
                            item.content = fileData.content;
                            item.download_url = fileData.download_url;

                            if ((!item.content || item.content.length === 0) && item.download_url) {
                                const response = await fetch(item.download_url);
                                if (!response.ok) {
                                    throw new Error(`Failed to download ${item.name} from URL`);
                                }
                                const arrayBuffer = await response.arrayBuffer();
                                byteArray = new Uint8Array(arrayBuffer);
                            } else if (item.content && item.content.length > 0) {
                                const byteCharacters = atob(item.content);
                                const byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                byteArray = new Uint8Array(byteNumbers);
                            } else {
                                throw new Error(`${item.name}: content is empty and no download URL available`);
                            }

                            zipFolder.file(item.name, byteArray);
                        } else if (item.type === 'dir') {
                            const subFolder = zipFolder.folder(item.name);
                            await addFilesToZip(item.path, subFolder);
                        }
                    }
                }

                await addFilesToZip(currentPath, zip);

                const blob = await zip.generateAsync({ type: 'blob' });

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const folderName = currentPath ? currentPath.split('/').pop() : 'files';
                a.download = `${folderName}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Download failed: ' + error.message);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = originalText;
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
            return Math.round(bytes / (1024 * 1024)) + ' MB';
        }

        function compareRows(rowA, rowB) {
            const a = rowA.cells[gOrderBy].getAttribute("sortable-data") || "";
            const b = rowB.cells[gOrderBy].getAttribute("sortable-data") || "";
            let numA = +a;
            let numB = +b;

            if (a == numA && b == numB) {
                return numA - numB;
            }
            return a.toLowerCase().localeCompare(b.toLowerCase());
        }

        function orderBy(column) {
            if (!gRows.length) return;

            let order;
            if (gOrderBy == column) {
                order = gTable.getAttribute("order") == "asc" ? "desc" : "asc";
            } else {
                order = "desc";
                gOrderBy = column;
            }

            gRows.sort(compareRows);

            gTable.removeChild(gTBody);
            gTable.setAttribute("order", order);
            gTable.setAttribute("order-by", column);

            if (order == "asc") {
                gRows.forEach(row => gTBody.appendChild(row));
            } else {
                gRows.reverse().forEach(row => gTBody.appendChild(row));
            }

            gTable.appendChild(gTBody);
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            const username = localStorage.getItem('username');
            const token = localStorage.getItem('auth_token');
            const usernameDiv = document.getElementById('profileUsername');

            if (usernameDiv && username) {
                let isAdmin = false;

                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        isAdmin = payload.role === 'admin';
                    } catch (e) {
                    }
                }

                usernameDiv.innerHTML = isAdmin
                    ? username + ' <i class="fa-solid fa-circle-check" style="color: #1da1f2;"></i>'
                    : username;
            }
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            window.location.hash = '';
            directoryCache = {};
            checkAuth();
        }

        document.addEventListener('click', function(event) {
            const profileContainer = document.querySelector('.profile-container');
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu && profileContainer && !profileContainer.contains(event.target)) {
                profileMenu.style.display = 'none';
            }
        });

        loadComponents().then(() => {
            checkAuth();

            window.addEventListener('pageshow', function(event) {
                checkAuth();
            });
        });
    </script>
</body>
</html>
