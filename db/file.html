<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: sans-serif;
            color: #666;
        }
        iframe, img, pre {
            width: 100%;
            height: 100vh;
            margin: 0;
            border: none;
        }
        pre {
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            background: #f5f5f5;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="loading">Loading file...</div>
    <div id="content" style="display:none;"></div>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api/github-proxy'
            : 'https://notes-api.ysw421.workers.dev';

        async function loadFile() {
            const params = new URLSearchParams(window.location.search);
            const path = params.get('path');
            const token = params.get('token');

            if (!path || !token) {
                document.getElementById('loading').textContent = 'Error: Missing path or token';
                return;
            }

            const fileName = path.split('/').pop();
            document.title = fileName;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, path })
                });

                if (!response.ok) {
                    throw new Error('Failed to load file');
                }

                const fileData = await response.json();

                if (fileData.download_url) {
                    window.location.href = fileData.download_url;
                } else if (fileData.content && fileData.content.length > 0) {
                    const binaryString = atob(fileData.content);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    let mimeType = 'application/octet-stream';
                    if (fileName.match(/\.(txt|md|log)$/i)) {
                        mimeType = 'text/plain';
                    } else if (fileName.match(/\.(html|htm)$/i)) {
                        mimeType = 'text/html';
                    } else if (fileName.match(/\.(js)$/i)) {
                        mimeType = 'text/javascript';
                    } else if (fileName.match(/\.(json)$/i)) {
                        mimeType = 'application/json';
                    } else if (fileName.match(/\.(css)$/i)) {
                        mimeType = 'text/css';
                    } else if (fileName.match(/\.(pdf)$/i)) {
                        mimeType = 'application/pdf';
                    } else if (fileName.match(/\.(png)$/i)) {
                        mimeType = 'image/png';
                    } else if (fileName.match(/\.(jpg|jpeg)$/i)) {
                        mimeType = 'image/jpeg';
                    } else if (fileName.match(/\.(gif)$/i)) {
                        mimeType = 'image/gif';
                    } else if (fileName.match(/\.(svg)$/i)) {
                        mimeType = 'image/svg+xml';
                    } else if (fileName.match(/\.(webp)$/i)) {
                        mimeType = 'image/webp';
                    }

                    const blob = new Blob([bytes], { type: mimeType });
                    const url = window.URL.createObjectURL(blob);

                    const content = document.getElementById('content');
                    const loading = document.getElementById('loading');

                    const isPdf = fileName.match(/\.(pdf)$/i);
                    const isImage = fileName.match(/\.(png|jpg|jpeg|gif|svg|webp)$/i);
                    const isText = fileName.match(/\.(txt|md|log|js|json|css|html|htm)$/i);

                    if (isPdf) {
                        const iframe = document.createElement('iframe');
                        iframe.src = url;
                        content.appendChild(iframe);
                    } else if (isImage) {
                        const img = document.createElement('img');
                        img.src = url;
                        content.appendChild(img);
                    } else if (isText) {
                        const text = new TextDecoder().decode(bytes);
                        const pre = document.createElement('pre');
                        pre.textContent = text;
                        content.appendChild(pre);
                    } else {
                        window.location.href = url;
                        return;
                    }

                    loading.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    throw new Error('File content is empty and no download URL available');
                }
            } catch (error) {
                document.getElementById('loading').textContent = 'Error: ' + error.message;
            }
        }

        loadFile();
    </script>
</body>
</html>
