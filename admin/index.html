<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Private Notes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../db/style.css" id="loginStyle">
    <link rel="stylesheet" href="../db/viewer.css" id="viewerStyle" disabled>
    <style>
        .admin-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .admin-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .admin-controls select,
        .admin-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .admin-controls button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .admin-controls button:hover {
            background: #0056b3;
        }
        .admin-controls button.btn-danger {
            background: #dc3545;
        }
        .admin-controls button.btn-danger:hover {
            background: #c82333;
        }
        .selected-count {
            font-weight: bold;
            color: #007bff;
        }
        .checkbox-col {
            width: 40px;
            text-align: center;
        }
        .checkbox-col input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        .permission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .permission-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .permission-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .permission-modal-content h2 {
            margin-top: 0;
        }
        .permission-group {
            margin-bottom: 20px;
        }
        .permission-group h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        .permission-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
        }
        .permission-item {
            padding: 5px;
            margin-bottom: 5px;
            background: white;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .permission-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-save {
            background: #28a745;
            color: white;
        }
        .btn-save:hover {
            background: #218838;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        .btn-cancel:hover {
            background: #5a6268;
        }
    </style>
</head>
<body dir="ltr">
    <div id="loginSection" style="display:none;">
        <div class="login-container">
            <h1>üîí Admin Panel</h1>
            <p>Admin credentials required</p>
            <form id="loginForm">
                <input type="text" id="username" placeholder="Username" autocomplete="username" required>
                <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>
                <button type="submit">Login</button>
            </form>
            <div id="error" class="error"></div>
        </div>
    </div>

    <div id="viewerSection" style="display:none;">
        <div class="admin-panel">
            <div class="admin-controls">
                <label>
                    <strong>User:</strong>
                    <select id="userSelect">
                        <option value="">Select user...</option>
                    </select>
                </label>
                <span class="selected-count">Selected: <span id="selectedCount">0</span> items</span>
                <button onclick="setPermissions('allow')">
                    <i class="fa-solid fa-check"></i> Allow Selected
                </button>
                <button onclick="setPermissions('deny')" class="btn-danger">
                    <i class="fa-solid fa-ban"></i> Deny Selected
                </button>
                <button onclick="showUserManagement()">
                    <i class="fa-solid fa-users"></i> Manage Users
                </button>
            </div>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h1 id="title" style="margin: 0; border: none; flex: 1;">Index of /</h1>
            <div class="profile-container" onclick="toggleProfileMenu()">
                <div class="profile-circle">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="profile-menu" id="profileMenu" style="display:none;">
                    <div class="profile-username" id="profileUsername"></div>
                    <button onclick="logout(); event.stopPropagation();">
                        <i class="fa-solid fa-sign-out-alt"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <div style="border-bottom: 1px solid ThreeDLightShadow; margin-bottom: 0.6em;"></div>
        <p id="UI_goUp" style="display:none">
            <a class="up" href="#" id="upLink">
                <i class="fa-solid fa-level-up-alt"></i>Up to higher level directory
            </a>
        </p>
        <table id="dirTable" order="">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th><a href="#" onclick="orderBy(0); return false;">Name</a></th>
                    <th><a href="#" onclick="orderBy(1); return false;">Size</a></th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div id="permissionModal" class="permission-modal">
        <div class="permission-modal-content">
            <h2>User Permissions: <span id="modalUsername"></span></h2>

            <div class="permission-group">
                <h3>Base Path</h3>
                <input type="text" id="basePath" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="/">
            </div>

            <div class="permission-group">
                <h3>Allowed Paths</h3>
                <div class="permission-list" id="allowedList"></div>
            </div>

            <div class="permission-group">
                <h3>Denied Paths</h3>
                <div class="permission-list" id="deniedList"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closePermissionModal()">Cancel</button>
                <button class="btn-save" onclick="savePermissions()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api/github-proxy'
            : 'https://notes-api.ysw421.workers.dev';

        const ADMIN_API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8787'
            : 'https://notes-api.ysw421.workers.dev';

        let currentPath = '';
        let allUsers = {};
        let selectedPaths = new Set();
        let currentUserPermissions = {};

        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const loginSection = document.getElementById('loginSection');
            const viewerSection = document.getElementById('viewerSection');
            const loginStyle = document.getElementById('loginStyle');
            const viewerStyle = document.getElementById('viewerStyle');

            if (!token) {
                loginSection.style.display = 'flex';
                viewerSection.style.display = 'none';
                loginStyle.disabled = false;
                viewerStyle.disabled = true;
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.role !== 'admin') {
                    alert('Admin access required');
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('username');
                    checkAuth();
                    return;
                }

                loginSection.style.display = 'none';
                viewerSection.style.display = 'block';
                loginStyle.disabled = true;
                viewerStyle.disabled = false;

                await loadUsers();
                loadFiles('');
            } catch (error) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('username');
                checkAuth();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');

            try {
                const response = await fetch(ADMIN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    const payload = JSON.parse(atob(data.token.split('.')[1]));

                    if (payload.role !== 'admin') {
                        errorDiv.textContent = '‚ùå Admin access required';
                        return;
                    }

                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('username', username);
                    checkAuth();
                } else {
                    errorDiv.textContent = '‚ùå Invalid credentials';
                }
            } catch (error) {
                errorDiv.textContent = '‚ùå Connection error';
            }
        });

        async function loadUsers() {
            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${ADMIN_API_URL}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, action: 'list' })
                });

                if (response.ok) {
                    const data = await response.json();
                    allUsers = data.users;

                    const userSelect = document.getElementById('userSelect');
                    userSelect.innerHTML = '<option value="">Select user...</option>';
                    Object.keys(allUsers).forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = `${username} (${allUsers[username].role})`;
                        userSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        document.getElementById('userSelect').addEventListener('change', (e) => {
            const username = e.target.value;
            if (username && allUsers[username]) {
                currentUserPermissions = allUsers[username].permissions;
            } else {
                currentUserPermissions = {};
            }
        });

        async function loadFiles(path) {
            currentPath = path;
            const token = localStorage.getItem('auth_token');
            const tbody = document.getElementById('tbody');
            const title = document.getElementById('title');
            const goUp = document.getElementById('UI_goUp');
            const upLink = document.getElementById('upLink');

            title.textContent = 'Index of /' + path;

            if (path) {
                goUp.style.display = 'block';
                const parentPath = path.split('/').slice(0, -1).join('/');
                upLink.onclick = () => { loadFiles(parentPath); return false; };
            } else {
                goUp.style.display = 'none';
            }

            try {
                const response = await fetch(ADMIN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, path })
                });

                if (!response.ok) throw new Error('Failed to load files');

                const files = await response.json();
                renderFiles(files);
            } catch (error) {
                alert('Error loading files: ' + error.message);
            }
        }

        function renderFiles(files) {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';

            files.forEach(file => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="checkbox-col">
                        <input type="checkbox" class="file-checkbox" data-path="${file.path}" onchange="updateSelectedCount()">
                    </td>
                    <td>
                        ${file.type === 'dir'
                            ? `<i class="fa-solid fa-folder"></i> <a href="#" onclick="loadFiles('${file.path}'); return false;">${file.name}/</a>`
                            : `<i class="fa-solid fa-file"></i> ${file.name}`
                        }
                    </td>
                    <td>${file.size || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            selectedPaths.clear();
            checkboxes.forEach(cb => selectedPaths.add(cb.dataset.path));
            document.getElementById('selectedCount').textContent = selectedPaths.size;
        }

        async function setPermissions(type) {
            const username = document.getElementById('userSelect').value;
            if (!username) {
                alert('Please select a user first');
                return;
            }

            if (selectedPaths.size === 0) {
                alert('Please select at least one file or folder');
                return;
            }

            const token = localStorage.getItem('auth_token');
            const user = allUsers[username];
            const paths = Array.from(selectedPaths);

            const permissions = { ...user.permissions };

            if (type === 'allow') {
                permissions.allowed = [...new Set([...(permissions.allowed || []), ...paths])];
                permissions.denied = (permissions.denied || []).filter(p => !paths.includes(p));
            } else {
                permissions.denied = [...new Set([...(permissions.denied || []), ...paths])];
                permissions.allowed = (permissions.allowed || []).filter(p => !paths.includes(p));
            }

            try {
                const response = await fetch(`${ADMIN_API_URL}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token,
                        action: 'update',
                        username,
                        permissions
                    })
                });

                if (response.ok) {
                    alert(`Successfully ${type === 'allow' ? 'allowed' : 'denied'} ${paths.length} path(s) for ${username}`);
                    await loadUsers();
                    selectedPaths.clear();
                    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('selectAll').checked = false;
                    updateSelectedCount();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showUserManagement() {
            window.open('user-management.html', '_blank');
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            const username = localStorage.getItem('username');
            const token = localStorage.getItem('auth_token');
            const usernameDiv = document.getElementById('profileUsername');

            if (usernameDiv && username) {
                let isAdmin = false;
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        isAdmin = payload.role === 'admin';
                    } catch (e) {}
                }
                usernameDiv.innerHTML = isAdmin
                    ? username + ' <i class="fa-solid fa-circle-check" style="color: #1da1f2;"></i>'
                    : username;
            }
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            checkAuth();
        }

        document.addEventListener('click', function(event) {
            const profileContainer = document.querySelector('.profile-container');
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu && profileContainer && !profileContainer.contains(event.target)) {
                profileMenu.style.display = 'none';
            }
        });

        checkAuth();
    </script>
</body>
</html>
